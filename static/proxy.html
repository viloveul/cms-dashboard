<!DOCTYPE html>
<html>
<head>
	<title>Proxy</title>
	<meta name="robots" content="noindex, nofollow">
</head>
<body>
	<script type="text/javascript">
		"use strict";
		var handler = function (event) {
			var url = window.localStorage.getItem('general:url') || '/';
			var brand = window.localStorage.getItem('general:brand') || 'Viloveul';
			if (event.data === 'viloveul.token') {
				let matched = url === event.origin || url === 'http://localhost' || url === 'http://127.0.0.1';
				if (matched === true || confirm("Share your access token on Dashboard " + brand + " with " + event.origin + " ?")) {
					event.source.postMessage(window.localStorage.getItem('vtoken'), event.origin);
				} else {
					event.source.postMessage('e', event.origin);
				}
			} else if (event.data !== 'viloveul.clear') {
				try {
					var parsed = JSON.parse(event.data);
					for (var b in window.localStorage) {
						if (b.search(/^features:/) !== -1) {
							window.localStorage.removeItem(b)
						}
					}
					for (var a in parsed) {
						if (a.search(/^features:/) !== -1) {
							window.localStorage.setItem(a, JSON.stringify(parsed[a]))
						}
					}
				} catch (e) {
					event.source.postMessage('e', event.origin);
				}
			} else {
				window.localStorage.clear()
			}
			window.removeEventListener('message', handler, true);
		};
		window.addEventListener("message", handler, true);
	</script>
</body>
</html>